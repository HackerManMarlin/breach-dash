<!doctype html>
<html>
<head>
  <title>Breach Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .high { color: #d9534f; font-weight: bold; }
    .medium { color: #f0ad4e; }
    .low { color: #5bc0de; }
    .critical { color: #d9534f; font-weight: bold; background-color: #f2dede; }
    .summary { font-style: italic; color: #666; }
    .breach-details { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; display: none; }
    .breach-details h3 { margin-top: 0; }
    .breach-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .breach-details-section { margin-bottom: 15px; }
    .breach-details-section h4 { margin-top: 0; margin-bottom: 5px; }
    .recommendations { list-style-type: disc; padding-left: 20px; }
    .sources { font-size: 0.9em; color: #666; }
    .filter-controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .search-box { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; max-width: 300px; }
    .severity-filter { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .portal-filter { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background-color: #f5f5f5; }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background-color: #0069d9;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .ai-analysis-section {
      border-top: 1px solid #ddd;
      margin-top: 20px;
      padding-top: 15px;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #007bff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .actions-column {
      white-space: nowrap;
      text-align: center;
    }
  </style>
</head>
<body>
<h2>Data Breach Dashboard</h2>

<div class="filter-controls">
  <input type="text" id="search-box" class="search-box" placeholder="Search entities...">
  <select id="severity-filter" class="severity-filter">
    <option value="all">All Severities</option>
    <option value="critical">Critical</option>
    <option value="high">High</option>
    <option value="medium">Medium</option>
    <option value="low">Low</option>
  </select>
  <select id="portal-filter" class="portal-filter">
    <option value="all">All Portals</option>
  </select>
</div>

<div id="tbl">Loading…</div>

<div id="breach-details" class="breach-details">
  <h3 id="breach-title">Breach Details</h3>
  <div class="breach-details-grid">
    <div class="breach-details-section">
      <h4>Breach Information</h4>
      <p><strong>Entity:</strong> <span id="detail-entity"></span></p>
      <p><strong>Records Affected:</strong> <span id="detail-records"></span></p>
      <p><strong>Date Reported:</strong> <span id="detail-notice-date"></span></p>
      <p><strong>Breach Date:</strong> <span id="detail-breach-date"></span></p>
      <p><strong>Severity:</strong> <span id="detail-severity"></span></p>
      <p><strong>Type:</strong> <span id="detail-type"></span></p>
      <p><strong>State:</strong> <span id="detail-state"></span></p>
    </div>
    <div class="breach-details-section">
      <h4>Basic Recommendations</h4>
      <ul class="recommendations">
        <li>Monitor your accounts for suspicious activity.</li>
        <li>Consider changing passwords for affected accounts.</li>
        <li>Be cautious of phishing attempts related to this breach.</li>
      </ul>
    </div>
  </div>

  <div id="ai-analysis-container" class="ai-analysis-section">
    <h4>AI Analysis</h4>
    <div id="ai-analysis-placeholder">
      <p>AI analysis is available on-demand for this breach.</p>
      <button id="run-ai-analysis" class="btn btn-primary">Run AI Analysis</button>
    </div>
    <div id="ai-analysis-loading" style="display: none;">
      <div class="loading-spinner"></div>
      <span>Analyzing breach data... This may take a minute.</span>
    </div>
    <div id="ai-analysis-results" style="display: none;">
      <div class="breach-details-grid">
        <div class="breach-details-section">
          <h4>Impact Assessment</h4>
          <p id="impact-assessment"></p>
        </div>
        <div class="breach-details-section">
          <h4>AI Summary</h4>
          <p id="ai-summary"></p>
        </div>
        <div class="breach-details-section">
          <h4>Personalized Recommendations</h4>
          <ul id="recommendations" class="recommendations"></ul>
        </div>
        <div class="breach-details-section">
          <h4>Sources</h4>
          <div id="sources" class="sources"></div>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top: 15px;">
    <button id="close-details" class="btn btn-secondary">Close Details</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supa = createClient("https://ejltctxcnootgerwxneq.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqbHRjdHhjbm9vdGdlcnd4bmVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2MTYzODUsImV4cCI6MjA2MzE5MjM4NX0.SCe8tnVQGui8XtAsKBNa7RrVKpoi9VXLbJ-tl50s73c");

// Get breach data with AI summaries
const { data: breaches } = await supa
  .from("breach_raw")
  .select(`
    *,
    breach_ai (
      summary
    )
  `)
  .order("inserted_at", { ascending: false })
  .limit(100);

// Get all breach data if the join with AI summaries returns no results
let displayData = breaches || [];

// Populate portal filter
const portalFilter = document.getElementById('portal-filter');
const portals = [...new Set(displayData.map(r => r._portal))].sort();
portals.forEach(portal => {
  const option = document.createElement('option');
  option.value = portal;
  option.textContent = portal;
  portalFilter.appendChild(option);
});

// Format the table
function renderTable(data) {
  if (!data || data.length === 0) {
    document.getElementById("tbl").innerHTML = `
      <div style="padding: 20px; background-color: #f8f9fa; border-radius: 5px; text-align: center;">
        <p>No breach data available. This could be because:</p>
        <ul style="text-align: left; display: inline-block;">
          <li>The GitHub Actions workflow hasn't run yet</li>
          <li>The scrapers haven't found any new breaches</li>
          <li>There might be an issue with the Supabase connection</li>
        </ul>
        <p>Check the GitHub Actions logs for more information.</p>
      </div>
    `;
  } else {
    document.getElementById("tbl").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Entity</th>
            <th>Records</th>
            <th>Type</th>
            <th>Portal</th>
            <th>Severity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${data.map((r, index) => {
            const severity = r.breach_ai?.summary?.severity || getSeverityFromRecords(r.records);
            const hasAiAnalysis = r.breach_ai && r.breach_ai.summary;
            return `
              <tr>
                <td>${r.notice_date || ""}</td>
                <td>${r.entity || ""}</td>
                <td>${formatNumber(r.records)}</td>
                <td>${r.breach_type || ""}</td>
                <td>${r._portal || ""}</td>
                <td class="${severity}">${severity.toUpperCase()}</td>
                <td class="actions-column">
                  <button class="btn btn-secondary view-details-btn" data-index="${index}">Details</button>
                  ${hasAiAnalysis ?
                    `<span title="AI analysis already available" style="color: green; margin-left: 5px;">✓</span>` :
                    ''}
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    // Add click event to view details buttons
    document.querySelectorAll('.view-details-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = btn.getAttribute('data-index');
        showBreachDetails(data[index]);
      });
    });
  }
}

// Initial render
renderTable(displayData);

// Filter functionality
const searchBox = document.getElementById('search-box');
const severityFilter = document.getElementById('severity-filter');

function applyFilters() {
  const searchTerm = searchBox.value.toLowerCase();
  const severityValue = severityFilter.value;
  const portalValue = portalFilter.value;

  const filteredData = displayData.filter(r => {
    // Search filter
    const matchesSearch = !searchTerm ||
      (r.entity && r.entity.toLowerCase().includes(searchTerm)) ||
      (r.breach_type && r.breach_type.toLowerCase().includes(searchTerm)) ||
      (r.state && r.state.toLowerCase().includes(searchTerm));

    // Severity filter
    const severity = r.breach_ai?.summary?.severity || getSeverityFromRecords(r.records);
    const matchesSeverity = severityValue === 'all' || severity === severityValue;

    // Portal filter
    const matchesPortal = portalValue === 'all' || r._portal === portalValue;

    return matchesSearch && matchesSeverity && matchesPortal;
  });

  renderTable(filteredData);
}

searchBox.addEventListener('input', applyFilters);
severityFilter.addEventListener('change', applyFilters);
portalFilter.addEventListener('change', applyFilters);

// Global variable to store the current breach being viewed
let currentBreach = null;

// Breach details functionality
function showBreachDetails(breach) {
  // Store the current breach for use in the AI analysis
  currentBreach = breach;

  const detailsElement = document.getElementById('breach-details');

  // Set basic details
  document.getElementById('breach-title').textContent = `Breach: ${breach.entity}`;
  document.getElementById('detail-entity').textContent = breach.entity || 'Unknown';
  document.getElementById('detail-records').textContent = formatNumber(breach.records);
  document.getElementById('detail-notice-date').textContent = breach.notice_date || 'Unknown';
  document.getElementById('detail-breach-date').textContent = breach.breach_date || 'Unknown';
  document.getElementById('detail-type').textContent = breach.breach_type || 'Unknown';
  document.getElementById('detail-state').textContent = breach.state || 'Unknown';

  // Set severity based on records
  const severity = getSeverityFromRecords(breach.records);
  document.getElementById('detail-severity').textContent = severity.toUpperCase();
  document.getElementById('detail-severity').className = severity;

  // Handle AI analysis section
  const aiPlaceholder = document.getElementById('ai-analysis-placeholder');
  const aiLoading = document.getElementById('ai-analysis-loading');
  const aiResults = document.getElementById('ai-analysis-results');

  // Reset AI sections
  aiPlaceholder.style.display = 'block';
  aiLoading.style.display = 'none';
  aiResults.style.display = 'none';

  // If AI analysis is already available, show it
  if (breach.breach_ai && breach.breach_ai.summary) {
    showAiResults(breach.breach_ai.summary);
  }

  // Show the details
  detailsElement.style.display = 'block';

  // Scroll to details
  detailsElement.scrollIntoView({ behavior: 'smooth' });
}

// Function to display AI results
function showAiResults(summary) {
  const aiPlaceholder = document.getElementById('ai-analysis-placeholder');
  const aiLoading = document.getElementById('ai-analysis-loading');
  const aiResults = document.getElementById('ai-analysis-results');

  // Update AI results
  document.getElementById('impact-assessment').textContent = summary.impact_assessment || '';
  document.getElementById('ai-summary').textContent = summary.text || '';

  // Recommendations
  const recommendationsElement = document.getElementById('recommendations');
  recommendationsElement.innerHTML = '';
  if (summary.recommendations && summary.recommendations.length > 0) {
    summary.recommendations.forEach(rec => {
      const li = document.createElement('li');
      li.textContent = rec;
      recommendationsElement.appendChild(li);
    });
  } else {
    recommendationsElement.innerHTML = '<li>No specific recommendations available.</li>';
  }

  // Sources
  const sourcesElement = document.getElementById('sources');
  sourcesElement.innerHTML = '';
  if (summary.sources && summary.sources.length > 0) {
    summary.sources.forEach(source => {
      const p = document.createElement('p');
      p.innerHTML = `<a href="${source}" target="_blank">${source}</a>`;
      sourcesElement.appendChild(p);
    });
  } else {
    sourcesElement.textContent = 'No external sources available.';
  }

  // Show results and hide other sections
  aiPlaceholder.style.display = 'none';
  aiLoading.style.display = 'none';
  aiResults.style.display = 'block';

  // Refresh the table to show the checkmark
  renderTable(displayData);
}

// Function to request AI analysis
async function requestAiAnalysis(breach) {
  try {
    // Show loading state
    document.getElementById('ai-analysis-placeholder').style.display = 'none';
    document.getElementById('ai-analysis-loading').style.display = 'block';

    // Call the Edge Function to analyze the breach
    const response = await fetch(`${supa.supabaseUrl}/functions/v1/enrich`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${supa.supabaseKey}`
      },
      body: JSON.stringify(breach)
    });

    if (!response.ok) {
      throw new Error(`Error: ${response.status} ${response.statusText}`);
    }

    // Wait a moment to allow the database to update
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Fetch the updated breach data with AI analysis
    const { data, error } = await supa
      .from('breach_ai')
      .select('summary')
      .eq('hash', breach.hash)
      .single();

    if (error) {
      throw new Error(`Error fetching AI analysis: ${error.message}`);
    }

    if (!data || !data.summary) {
      throw new Error('No AI analysis data returned');
    }

    // Update the current breach with the AI analysis
    if (!currentBreach.breach_ai) {
      currentBreach.breach_ai = { summary: data.summary };
    } else {
      currentBreach.breach_ai.summary = data.summary;
    }

    // Update the display with the AI results
    showAiResults(data.summary);

    // Update the breach in the displayData array
    const index = displayData.findIndex(b => b.hash === breach.hash);
    if (index !== -1) {
      displayData[index] = currentBreach;
    }

  } catch (error) {
    console.error('Error requesting AI analysis:', error);

    // Show error in the results section
    document.getElementById('ai-analysis-placeholder').style.display = 'none';
    document.getElementById('ai-analysis-loading').style.display = 'none';
    document.getElementById('ai-analysis-results').style.display = 'block';

    document.getElementById('impact-assessment').textContent = 'Error analyzing breach data.';
    document.getElementById('ai-summary').textContent = `An error occurred: ${error.message}`;
    document.getElementById('recommendations').innerHTML = '<li>Please try again later.</li>';
    document.getElementById('sources').textContent = 'No sources available due to error.';
  }
}

// Close details button
document.getElementById('close-details').addEventListener('click', () => {
  document.getElementById('breach-details').style.display = 'none';
});

// Run AI Analysis button
document.getElementById('run-ai-analysis').addEventListener('click', () => {
  if (currentBreach) {
    requestAiAnalysis(currentBreach);
  }
});

// Helper functions
function getSeverityFromRecords(records) {
  if (!records) return "low";
  if (records >= 100000) return "critical";
  if (records >= 10000) return "high";
  if (records >= 1000) return "medium";
  return "low";
}

function formatNumber(num) {
  if (!num) return "0";
  return new Intl.NumberFormat().format(num);
}
</script>
</body>
</html>